from openai import OpenAI
from .base import BaseAgent
from .registry import register_agent
from groq import Groq

@register_agent("parser")
class TransactionParser(BaseAgent):
    def __init__(self, agent_name, model="openai/gpt-oss-20b", endpoint="https://api.groq.com/openai/v1/chat/completions", 
                 api_key='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'):
        super().__init__(agent_name, model, endpoint, api_key)
        self.client = Groq(api_key=self.api_key)
        
    def parse(self, text: str, description: str) -> str:
        prompt = f"""
                    Ø´Ù…Ø§ ÛŒÚ© Ø³ÛŒØ³ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø² Ù¾ÛŒØ§Ù…Ú©â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ù†Ú©ÛŒ Ù‡Ø³ØªÛŒØ¯. Ù„Ø·ÙØ§Ù‹ Ù¾ÛŒØ§Ù…Ú© Ø²ÛŒØ± Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù† Ùˆ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ØµÙ„ÛŒ Ø¢Ù† Ø±Ø§ Ø¨Ù‡â€ŒØµÙˆØ±Øª Ø¯Ù‚ÛŒÙ‚ Ø¯Ø± Ù‚Ø§Ù„Ø¨ JSON Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ú©Ù†.

                    ðŸ“© **Ù¾ÛŒØ§Ù…Ú©:**
                    {text}

                    ØªÙˆØ¶ÛŒØ­Ø§Øª ØªØ±Ø§Ú©Ù†Ø´ : {description}
                    ðŸ“Œ **Ù‚ÙˆØ§Ù†ÛŒÙ† Ù¾Ø±Ø¯Ø§Ø²Ø´:**

                    Û±. ÙÙ‚Ø· Ø®Ø±ÙˆØ¬ÛŒ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ JSON Ø¨Ø¯Ù‡. Ø¨Ø¯ÙˆÙ† Ù‡ÛŒÚ† Ù…ØªÙ† ØªÙˆØ¶ÛŒØ­ÛŒ Ù‚Ø¨Ù„ ÛŒØ§ Ø¨Ø¹Ø¯ Ø§Ø² Ø¢Ù†.

                    Û². Ú©Ù„ÛŒØ¯Ù‡Ø§ÛŒ Ù…ÙˆØ±Ø¯ Ø§Ù†ØªØ¸Ø§Ø± Ø¯Ø± Ø®Ø±ÙˆØ¬ÛŒ ÙÙ‚Ø· Ø§ÛŒÙ†â€ŒÙ‡Ø§ Ù‡Ø³ØªÙ†Ø¯:
                    - `amount` (Ø¹Ø¯Ø¯ Ø®Ø§Ù„ØµØŒ ÙÙ‚Ø· Ø±Ù‚Ù…ØŒ Ø¨Ø¯ÙˆÙ† Ø¹Ù„Ø§Ù…Øª + ÛŒØ§ , ÛŒØ§ ØªÙˆÙ…Ø§Ù†)
                    - `account` (Ø´Ù…Ø§Ø±Ù‡ Ø­Ø³Ø§Ø¨)
                    - `balance` (Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ù†Ù‡Ø§ÛŒÛŒ Ø­Ø³Ø§Ø¨ØŒ ÙÙ‚Ø· Ø¹Ø¯Ø¯ Ø®Ø§Ù„Øµ)
                    - `datetime` (ØªØ§Ø±ÛŒØ® Ùˆ Ø³Ø§Ø¹Øª ØªØ±Ø§Ú©Ù†Ø´ØŒ Ø¨Ù‡ ÙØ±Ù…Øª Ù†ÙˆØ´ØªÙ‡â€ŒØ´Ø¯Ù‡ Ø¯Ø± Ù¾ÛŒØ§Ù…)
                    - `type` (Ø¹Ø¯Ø¯ÛŒ Ø¨Ø§Ø´Ø¯: ÙˆØ§Ø±ÛŒØ² = 1ØŒ Ø¨Ø±Ø¯Ø§Ø´Øª = -1)

                    Û³. Ø§Ú¯Ø± Ø¯Ø± Ù…ØªÙ†ØŒ Ù†ÙˆØ¹ ØªØ±Ø§Ú©Ù†Ø´ ÙˆØ§Ø±ÛŒØ² Ø¨ÙˆØ¯ (Ù…Ø«Ù„Ø§Ù‹ "ÙˆØ§Ø±ÛŒØ²"ØŒ "Ø¯Ø±ÛŒØ§ÙØª"ØŒ "ÙˆØµÙˆÙ„") Ù…Ù‚Ø¯Ø§Ø± `type` Ø±Ø§ Ø¨Ø±Ø§Ø¨Ø± Ø¨Ø§ **1** Ù‚Ø±Ø§Ø± Ø¨Ø¯Ù‡.
                    Ø§Ú¯Ø± Ø¨Ø±Ø¯Ø§Ø´Øª Ø¨ÙˆØ¯ (Ù…Ø«Ù„Ø§Ù‹ "Ø¨Ø±Ø¯Ø§Ø´Øª"ØŒ "Ø®Ø±ÛŒØ¯"ØŒ "Ù¾Ø±Ø¯Ø§Ø®Øª"ØŒ "Ú©Ø³Ø±"ØŒ "Ø¨Ø±Ø¯Ø§Ø´Øª Ù†Ù‚Ø¯ÛŒ") Ù…Ù‚Ø¯Ø§Ø± `type` Ø±Ø§ **-1** Ù‚Ø±Ø§Ø± Ø¨Ø¯Ù‡.
                    Ø¨Ù‡ ØªÙˆØ¶ÛŒØ­Ø§Øª ØªØ±Ø§Ú©Ù†Ø´ Ù‡Ù… Ø¯Ù‚Øª Ú©Ù† Ùˆ Ø§ÙˆÙ†Ù… Ø¯Ø± ØªØµÙ…ÛŒÙ… Ú¯ÛŒØ±ÛŒ Ø±Ø§Ø¬Ø¨ Ø¨Ø±Ø¯Ø§Ø´Øª ÛŒØ§ ÙˆØ§Ø±ÛŒØ² ØªØ§Ø«ÛŒØ± Ø¨Ø¯Ù‡ Ú†ÙˆÙ† Ù…Ù‡Ù… Ø§Ø³Øª.

                    Û´. Ù…Ù‚Ø¯Ø§Ø± `amount` Ùˆ `balance` Ø¨Ø§ÛŒØ¯ ÙÙ‚Ø· Ø¹Ø¯Ø¯ Ø¨Ø§Ø´Ù†Ø¯ (Ù…Ø«Ù„: 1250000). Ù‡Ù…Ù‡â€ŒÛŒ Ø¹Ù„Ø§Ø¦Ù… ÙØ§Ø±Ø³ÛŒØŒ Ø¹Ù„Ø§Ù…Øª Ù…Ù†ÙÛŒØŒ ØªÙˆÙ…Ø§Ù†ØŒ Ùˆ Ú©Ø§Ù…Ø§ (,) Ø¨Ø§ÛŒØ¯ Ø­Ø°Ù Ø´ÙˆÙ†Ø¯.

                    Ûµ. Ø§Ú¯Ø± Ù…Ù‚Ø¯Ø§Ø± ÛŒØ§ ÙÛŒÙ„Ø¯ÛŒ Ø¯Ø± Ù…ØªÙ† Ù†Ø¨ÙˆØ¯ ÛŒØ§ Ù‚Ø§Ø¨Ù„ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù†Ø¨ÙˆØ¯ØŒ Ù…Ù‚Ø¯Ø§Ø± Ø¢Ù† Ø±Ø§ Ø¨Ø±Ø§Ø¨Ø± Ø¨Ø§ `null` Ù‚Ø±Ø§Ø± Ø¨Ø¯Ù‡.

                    Û¶. Ù‡Ù…ÛŒØ´Ù‡ Ø®Ø±ÙˆØ¬ÛŒ Ø±Ø§ ÙÙ‚Ø· Ø¨Ø§ ÙØ±Ù…Øª JSON Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†. Ù‡Ø±Ú¯ÙˆÙ†Ù‡ Ù…ØªÙ† Ø§Ø¶Ø§ÙÛŒ Ù…Ù…Ù†ÙˆØ¹ Ø§Ø³Øª.

                    ðŸ” **Ù†Ù…ÙˆÙ†Ù‡ Ø®Ø±ÙˆØ¬ÛŒ ØµØ­ÛŒØ­:**
                    ```json
                    {{
                    "amount": 380000,
                    "account": "710121355964",
                    "balance": 451230,
                    "datetime": "0421-19:58",
                    "type": -1
                }} """

        response = self.client.chat.completions.create(
            model=self.model,
            messages=[{"role": "user", "content": prompt}]
        )
        return response.choices[0].message.content
    
    def analyst(self) -> str:
        return "Analyst not implemented in this agent."