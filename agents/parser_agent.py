from openai import OpenAI
from .base import BaseAgent
from .registry import register_agent

@register_agent("parser")
class TransactionParser(BaseAgent):
    def __init__(self, agent_name, model="gpt-4o", endpoint="https://api.gapgpt.app/v1", api_key='sk-NoXiKQ9JB8qPlauOmNdNqUiS7tLC4Yp6qWLgkp9BGuL0f2Z7'):
        super().__init__(agent_name, model, endpoint, api_key)
        self.client = OpenAI(base_url=self.endpoint, api_key=self.api_key)

    def parse(self, text: str) -> str:
        prompt = f"""
                    ุดูุง ฺฉ ุณุณุชู ุงุณุชุฎุฑุงุฌ ุงุทูุงุนุงุช ุงุฒ ูพุงูฺฉโูุง ุจุงูฺฉ ูุณุชุฏ. ูุทูุงู ูพุงูฺฉ ุฒุฑ ุฑุง ุจุฑุฑุณ ฺฉู ู ุงุทูุงุนุงุช ุงุตู ุขู ุฑุง ุจูโุตูุฑุช ุฏูู ุฏุฑ ูุงูุจ JSON ุงุณุชุฎุฑุงุฌ ฺฉู.

                    ๐ฉ **ูพุงูฺฉ:**
                    {text}

                    ๐ **ููุงูู ูพุฑุฏุงุฒุด:**

                    ฑ. ููุท ุฎุฑูุฌ ุงุณุชุงูุฏุงุฑุฏ JSON ุจุฏู. ุจุฏูู ูฺ ูุชู ุชูุถุญ ูุจู ุง ุจุนุฏ ุงุฒ ุขู.

                    ฒ. ฺฉูุฏูุง ููุฑุฏ ุงูุชุธุงุฑ ุฏุฑ ุฎุฑูุฌ ููุท ุงูโูุง ูุณุชูุฏ:
                    - `amount` (ุนุฏุฏ ุฎุงูุตุ ููุท ุฑููุ ุจุฏูู ุนูุงูุช + ุง , ุง ุชููุงู)
                    - `account` (ุดูุงุฑู ุญุณุงุจ)
                    - `balance` (ููุฌูุฏ ููุง ุญุณุงุจุ ููุท ุนุฏุฏ ุฎุงูุต)
                    - `datetime` (ุชุงุฑุฎ ู ุณุงุนุช ุชุฑุงฺฉูุดุ ุจู ูุฑูุช ููุดุชูโุดุฏู ุฏุฑ ูพุงู)
                    - `type` (ุนุฏุฏ ุจุงุดุฏ: ูุงุฑุฒ = 1ุ ุจุฑุฏุงุดุช = -1)

                    ณ. ุงฺฏุฑ ุฏุฑ ูุชูุ ููุน ุชุฑุงฺฉูุด ูุงุฑุฒ ุจูุฏ (ูุซูุงู "ูุงุฑุฒ"ุ "ุฏุฑุงูุช"ุ "ูุตูู") ููุฏุงุฑ `type` ุฑุง ุจุฑุงุจุฑ ุจุง **1** ูุฑุงุฑ ุจุฏู.
                    ุงฺฏุฑ ุจุฑุฏุงุดุช ุจูุฏ (ูุซูุงู "ุจุฑุฏุงุดุช"ุ "ุฎุฑุฏ"ุ "ูพุฑุฏุงุฎุช"ุ "ฺฉุณุฑ"ุ "ุจุฑุฏุงุดุช ููุฏ") ููุฏุงุฑ `type` ุฑุง **-1** ูุฑุงุฑ ุจุฏู.

                    ด. ููุฏุงุฑ `amount` ู `balance` ุจุงุฏ ููุท ุนุฏุฏ ุจุงุดูุฏ (ูุซู: 1250000). ูููโ ุนูุงุฆู ูุงุฑุณุ ุนูุงูุช ูููุ ุชููุงูุ ู ฺฉุงูุง (,) ุจุงุฏ ุญุฐู ุดููุฏ.

                    ต. ุงฺฏุฑ ููุฏุงุฑ ุง ููุฏ ุฏุฑ ูุชู ูุจูุฏ ุง ูุงุจู ุงุณุชุฎุฑุงุฌ ูุจูุฏุ ููุฏุงุฑ ุขู ุฑุง ุจุฑุงุจุฑ ุจุง `null` ูุฑุงุฑ ุจุฏู.

                    ถ. ููุดู ุฎุฑูุฌ ุฑุง ููุท ุจุง ูุฑูุช JSON ุจุฑฺฏุฑุฏุงู. ูุฑฺฏููู ูุชู ุงุถุงู ููููุน ุงุณุช.

                    ๐ **ููููู ุฎุฑูุฌ ุตุญุญ:**
                    ```json
                    {{
                    "amount": 380000,
                    "account": "710121355964",
                    "balance": 451230,
                    "datetime": "0421-19:58",
                    "type": -1
                }} """

        response = self.client.chat.completions.create(
            model=self.model,
            messages=[{"role": "user", "content": prompt}]
        )
        return response.choices[0].message.content
